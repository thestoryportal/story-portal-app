{
  "name": "electricity-portal",
  "description": "Electricity arc effect inside the portal ring",

  "capture": {
    "selector": "[data-capture='portal']",
    "fallbackSelector": ".portal-container",
    "duration": 3200,
    "fps": 30,
    "captureMode": "video",
    "videoFps": 30,
    "extractFrames": true,
    "waitForEffect": true,
    "effectReadySignal": "window.__CAPTURE__?.effectActive",
    "viewport": { "width": 1440, "height": 768 },
    "deviceScaleFactor": 1,
    "settleMs": 500,
    "headless": false,
    "mode": "newtopics",
    "crop": {
      "x": 482,
      "y": 39,
      "width": 465,
      "height": 465,
      "circularMask": true,
      "maskOffsetX": 0,
      "maskOffsetY": 0,
      "maskRadiusAdjust": 0,
      "_note": "Calibrated 2025-12-24: 465x465, x=482 y=39 (left 1px, down 1px for mask alignment)"
    },
    "effectTiming": {
      "startMs": 1200,
      "endMs": 2000,
      "targetFrameCount": 128,
      "loopToMatch": true,
      "_note": "Peak stable window (1200-2000ms, 0.8s). Loop to match reference 128 frames."
    }
  },

  "reference": {
    "withEffect": "animations/electricity-portal/references/465x465/electricity_animation_effect_static_diff_analysis.png",
    "withoutEffect": "animations/electricity-portal/references/465x465/electricity_animation_effect_off_baseline.png",
    "animationOriginal": "animations/electricity-portal/references/465x465/electricity_animation_effect_reference_original.apng",
    "animation": "animations/electricity-portal/references/465x465/electricity_animation_effect_diff_analysis.apng",
    "mask": "animations/electricity-portal/references/465x465/electricity_animation_effect_diff_analysis_mask.png",
    "_maskSpec": {
      "format": "white ellipse on black (binary)",
      "innerSize": "319x317",
      "center": { "x": 232.5, "y": 232.5 },
      "radii": { "rx": 159.5, "ry": 158.5 }
    },
    "_alignment": {
      "resizeTo": { "width": 452, "height": 463 },
      "offsetOnCanvas": { "x": 5, "y": 1 },
      "canvasSize": 465,
      "calibratedDate": "2025-12-23",
      "_note": "Original reference resized to create diff_analysis version"
    },
    "baseline": "animations/electricity-portal/references/465x465/quality_spec.json",
    "baselineMetrics": "animations/electricity-portal/references/465x465/baseline_metrics.json",
    "animationBaseline": "animations/electricity-portal/references/465x465/baseline_animation_metrics.json",
    "_legacy": {
      "withEffect": "animations/electricity-portal/references/465x465/with_effect.png",
      "animation": "animations/electricity-portal/references/465x465/reference_animation.apng",
      "_note": "Original hand-crafted reference preserved for comparison"
    },
    "_soraSource": {
      "original": "animations/electricity-portal/references/focus/electricity-effect-animated reference-video.mp4",
      "generatedDate": "2025-12-22",
      "speedup": "1.5x",
      "_note": "AI-generated reference from Sora/Luma using prompt from visual spec"
    }
  },

  "thresholds": {
    "ssim": {
      "fail": 0.70,
      "pass": 0.85,
      "good": 0.90,
      "excellent": 0.93,
      "_ceilingNote": "Max achievable ~0.95-0.97 due to AI reference vs live app rendering differences"
    },
    "diffPercent": {
      "max": 15,
      "warning": 10,
      "ideal": 5
    },
    "pauseEveryN": 7,
    "_maxIterationsNote": "No absolute cap. Pause every 7 iterations for human checkpoint."
  },

  "convergence": {
    "plateauThreshold": 0.01,
    "plateauIterations": 3,
    "plateauAction": "MANDATORY_ESCALATION",
    "targetSsim": 0.90,
    "_note": "3 iterations with <1% net change triggers immediate stop"
  },

  "feedback": {
    "includeHeatmap": true,
    "includeComparison": true,
    "includePerFrameScores": false,
    "maxFramesToShow": 6
  },

  "codeTargets": {
    "core": [
      "src/legacy/components/ElectricityR3F.tsx"
    ],
    "supporting": [
      "src/legacy/constants/config.ts"
    ],
    "_note": "R3F component is primary iteration target. Config provides color/timing constants.",
    "_legacy": [
      "src/legacy/effects/shaders.ts",
      "src/legacy/effects/boltGenerator.ts",
      "src/legacy/effects/useElectricityEffect.ts",
      "src/legacy/effects/useElectricityEffectThree.ts"
    ]
  },

  "setupStatus": {
    "viewportVerified": true,
    "cropCalibrated": true,
    "maskVerified": true,
    "timingVerified": true,
    "videoPipelineVerified": true,
    "referenceAlignmentComplete": true,
    "verifiedDate": "2025-12-24",
    "captureFormat": "jpeg",
    "captureMode": "video-screencast",
    "croppingMethod": "sharp-extract",
    "effectDuration": "0.8s (peak-only window)",
    "effectTimingMs": "1200-2000",
    "circularMaskApplied": true,
    "cropCoordinates": "482,39 @ 465x465",
    "soraAlignmentParams": "452x463, offset (5,1) on 465x465 canvas",
    "_calibrationNote": "Calibrated 2025-12-24: crop x=482 y=39 (mask alignment), timing 1200-2000ms (peak-only window)"
  },

  "visualSpec": {
    "color": {
      "primary": "#FFB800",
      "secondary": "#FF6B00",
      "glow": "#FFF4D4"
    },
    "characteristics": [
      "Bright orange/yellow electricity arcs",
      "Intense radial glow from center",
      "Multiple branching lightning bolts",
      "Pulsing/flickering animation",
      "No visible background through effect"
    ]
  },

  "temporalEnvelope": {
    "description": "Intensity curve from button press to effect end",
    "phases": {
      "build": {
        "durationMs": "800-1200",
        "behavior": "Bolts energize from inner rim of portal ring inward toward center",
        "intensityCurve": "ease-in (slow start, accelerating)"
      },
      "peak": {
        "durationMs": "1000-1500",
        "behavior": "Full intensity, maximum bolt activity and glow",
        "intensityCurve": "sustained with natural flicker"
      },
      "decay": {
        "durationMs": "500-800",
        "behavior": "Intensity decreases, bolts fade out",
        "intensityCurve": "ease-out (decelerating to zero)"
      }
    },
    "totalDurationMs": "2500-3500",
    "_referenceNote": "Sora reference shows constant peak intensity throughout. Use Sora for VISUAL quality at peak. Use this spec for TEMPORAL envelope shape."
  },

  "twoPhaseApproach": {
    "description": "Iterate in two distinct phases: peak visuals first, then envelope",

    "phase1": {
      "name": "Peak Visual Quality",
      "goal": "Match Sora reference at constant peak intensity",
      "captureMode": "peak-only",
      "captureDurationMs": 1500,
      "captureSettleMs": 1000,
      "captureNote": "Skip build phase, capture only during peak intensity window",
      "compareAgainst": "Both static and animation baselines (fully applicable)",
      "targetSsim": 0.90,
      "exitCriteria": "SSIM >= 0.90 AND human approval",
      "outputLock": "Lock all Phase 1 parameters before proceeding to Phase 2"
    },

    "phase2": {
      "name": "Envelope Implementation",
      "goal": "Add build and decay while preserving Phase 1 visual quality",
      "captureMode": "full-envelope",
      "captureDurationMs": 3500,
      "captureSettleMs": 0,
      "captureNote": "Capture full animation including build, peak, and decay",
      "compareAgainst": "Temporal envelope spec (not SSIM to Sora)",
      "validation": "Visual inspection against temporalEnvelope spec",
      "constraint": "Phase 1 locked parameters MUST NOT be modified"
    }
  },

  "parameterCategories": {
    "phase1Locked": {
      "description": "Parameters locked after Phase 1 completion - DO NOT MODIFY in Phase 2",
      "shaders.ts": [
        "orangeTint (vec3 color values)",
        "u_intensity (base intensity)",
        "u_bloomTightWeight",
        "u_bloomMedWeight",
        "u_bloomWideWeight",
        "u_exposure",
        "ACES tonemapping coefficients"
      ],
      "boltGenerator.ts": [
        "BOLT_WIDTH",
        "BRANCH_PROBABILITY",
        "SEGMENT_LENGTH",
        "JITTER",
        "MAX_BRANCHES",
        "bolt path generation algorithms"
      ],
      "config.ts": [
        "plasmaDensity",
        "bloomTightWeight",
        "bloomMedWeight",
        "bloomWideWeight",
        "toneMapExposure",
        "centerGlowStrength"
      ]
    },
    "phase2Tunable": {
      "description": "Parameters for envelope implementation - modify only in Phase 2",
      "useElectricityEffect.ts": [
        "intensityEnvelope (build/peak/decay curve)",
        "envelopeTiming (phase durations)",
        "fadeInDuration",
        "fadeOutDuration"
      ],
      "boltGenerator.ts": [
        "spawnRateMultiplier (over time)",
        "intensityMultiplier (over time)"
      ],
      "config.ts": [
        "buildDurationMs",
        "peakDurationMs",
        "decayDurationMs",
        "envelopeCurve (easing function)"
      ]
    }
  },

  "currentPhase": {
    "phase": 1,
    "status": "not_started",
    "iteration": 0,
    "bestSsim": null,
    "phase1CompletedDate": null,
    "lockedParameters": null
  }
}
